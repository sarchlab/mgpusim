# Docker-based HIP compilation for vectoradd
# Uses ROCm Docker image - no local ROCm installation required

DOCKER_IMAGE = rocm/dev-ubuntu-24.04:7.1.1
GPU_TARGET = gfx942
SRC = vectoradd.cpp
# The GPU code object file generated by --save-temps
GPU_OBJ = vectoradd-hip-amdgcn-amd-amdhsa-$(GPU_TARGET).o
HSACO = vectoradd.hsaco
DISASM = vectoradd.disasm

# Run hipcc inside Docker container
# --platform linux/amd64 required for Apple Silicon Macs
DOCKER_RUN = docker run --rm --platform linux/amd64 -v $(PWD):/work -w /work $(DOCKER_IMAGE)

.PHONY: all clean clean-all regen-disasm

all: $(HSACO)

# Compile HIP source with --save-temps to get intermediate GPU object file
# The GPU ELF code object is vectoradd-hip-amdgcn-amd-amdhsa-gfx942.o
$(HSACO): $(SRC)
	$(DOCKER_RUN) hipcc --save-temps -c --offload-arch=$(GPU_TARGET) $<
	cp $(GPU_OBJ) $(HSACO)

# Regenerate LLVM disassembly (requires Docker)
# Use this to update the reference file when HSACO changes
regen-disasm: $(HSACO)
	$(DOCKER_RUN) /opt/rocm/llvm/bin/llvm-objdump --disassemble --mcpu=$(GPU_TARGET) $(HSACO) > $(DISASM)
	@echo "Updated $(DISASM)"

clean:
	rm -f vectoradd.mgpusim.disasm *.ll *.bc *.s *.o *.cui *.fatbin *.hipfb
	@echo "Note: $(HSACO) and $(DISASM) are preserved (checked into git)"

clean-all: clean
	rm -f $(HSACO) $(DISASM)
